#!/bin/sh

# commit-msg hook: Enforce TDD cycle discipline.
#
# Every commit must declare its TDD phase:
#   ğŸ”´ â€” Red:     writing failing tests. Tests must fail.
#   ğŸŸ¢ â€” Green:   making tests pass. Tests must pass. Must follow ğŸ”´.
#   â™»ï¸  â€” Refactor: structural cleanup. Tests must pass. No new behavior.
#   ğŸ”€ â€” Merge:   integrating branches. Tests must pass. No sequence rule.
#
# Sequence rule: ğŸ”´ must be immediately followed by ğŸŸ¢.
#
# Canonical source: ~/.os/git.nix â€” update there first, then sync here.
#
# Stash isolation: runs checks against staged changes only.
# Unstaged changes are stashed before running and restored after.

COMMIT_MSG_FILE="$1"
# Phase markers are only checked on the subject line (first line)
SUBJECT=$(head -1 "$COMMIT_MSG_FILE")

has_red=$(echo "$SUBJECT" | grep -c "ğŸ”´")
has_green=$(echo "$SUBJECT" | grep -c "ğŸŸ¢")
has_refactor=$(echo "$SUBJECT" | grep -c "â™»ï¸")
has_merge=$(echo "$SUBJECT" | grep -c "ğŸ”€")

# Require exactly one phase marker
total=$((has_red + has_green + has_refactor + has_merge))

if [ "$total" -eq 0 ]; then
  echo ""
  echo "âŒ Commit rejected: missing TDD phase marker."
  echo ""
  echo "   Every commit must declare its phase:"
  echo "   ğŸ”´ â€” Red: write failing tests (tests must fail)"
  echo "   ğŸŸ¢ â€” Green: make tests pass (tests must pass, must follow ğŸ”´)"
  echo "   â™»ï¸  â€” Refactor: structural only (tests must pass, no new behavior)"
  echo "   ğŸ”€ â€” Merge: integrating branches (tests must pass)"
  echo ""
  exit 1
fi

if [ "$total" -gt 1 ]; then
  echo ""
  echo "âŒ Commit rejected: multiple phase markers found. Pick exactly one."
  echo ""
  exit 1
fi

# Sequence check: if previous commit was ğŸ”´, current must be ğŸŸ¢
prev_subject=$(git log -1 --format="%s" 2>/dev/null)
prev_was_red=$(echo "$prev_subject" | grep -c "ğŸ”´")

if [ "$prev_was_red" -gt 0 ] && [ "$has_green" -eq 0 ]; then
  echo ""
  echo "âŒ Commit rejected: previous commit was ğŸ”´ â€” this commit must be ğŸŸ¢."
  echo "   Make the failing tests pass before committing as anything else."
  echo ""
  exit 1
fi

# Run just pre-commit against staged changes only.
# Unstaged changes are stashed before checks and restored after.
run_staged() {
  before=$(git stash list | wc -l)
  git stash push --keep-index --quiet 2>/dev/null || true
  after=$(git stash list | wc -l)
  just pre-commit 2>&1
  status=$?
  if [ "$after" -gt "$before" ]; then
    git stash pop --quiet 2>/dev/null || true
  fi
  return $status
}

# Phase-specific validation
if [ "$has_red" -gt 0 ]; then
  echo "ğŸ”´ Red phase â€” verifying tests fail..."
  run_staged
  if [ $? -eq 0 ]; then
    echo ""
    echo "âŒ Commit rejected: declared ğŸ”´ but tests are passing."
    echo "   Write a failing test first, then commit."
    echo ""
    exit 1
  fi
  echo "âœ“ Tests are red. Commit accepted."
  exit 0
fi

if [ "$has_green" -gt 0 ]; then
  echo "ğŸŸ¢ Green phase â€” verifying tests pass..."
  run_staged
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Commit rejected: declared ğŸŸ¢ but tests are failing."
    echo "   Make the tests pass before committing as ğŸŸ¢."
    echo ""
    exit 1
  fi
  echo "âœ“ Tests are green. Commit accepted."
  exit 0
fi

if [ "$has_refactor" -gt 0 ]; then
  echo "â™»ï¸  Refactor phase â€” verifying just pre-commit passes..."
  run_staged
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Commit rejected: declared â™»ï¸ but tests are failing."
    echo "   Refactors must not change behavior. Fix the breakage first."
    echo ""
    exit 1
  fi
  echo "âœ“ Checks pass. Refactor accepted."
  exit 0
fi

if [ "$has_merge" -gt 0 ]; then
  echo "ğŸ”€ Merge â€” verifying tests pass..."
  run_staged
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Commit rejected: declared ğŸ”€ but tests are failing."
    echo "   Resolve conflicts so tests pass before completing the merge."
    echo ""
    exit 1
  fi
  echo "âœ“ Tests pass. Merge accepted."
  exit 0
fi
